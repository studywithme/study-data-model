# 4-6. 차원 모델링 용어 탐방(2): Fact, Fact 테이블 📊

## 📖 학습 목표
- Fact(팩트)의 개념과 특성 이해
- Fact 테이블의 구조와 설계 방법 학습
- 다양한 Fact 테이블 유형 파악

## 🎯 Fact(팩트)란?

### 정의
**Fact(팩트)**는 비즈니스 프로세스에서 발생하는 측정 가능한 사건이나 
수치를 의미하며, 분석의 핵심 대상이 되는 데이터입니다.

### 온도계와의 비유
```
온도계                  Fact
─────────────────     ─────────────────
측정된 온도 수치   →   측정된 비즈니스 수치
시간별 변화        →   시간별 데이터 변화
정확한 측정        →   정확한 데이터 수집
분석의 기준        →   분석의 핵심 데이터
객관적 사실        →   객관적 비즈니스 사실
```

## 📐 Fact의 특성

### 1. 수치적 특성
```
특징:
- 숫자형 데이터
- 측정 가능한 값
- 집계 연산 가능
- 시간에 따라 변화

예시:
매출금액: 150,000원
판매수량: 5개
할인금액: 15,000원
이익률: 25.5%
고객수: 1,250명
```

### 2. 가산성 (Additivity)
```
가산형 (Additive):
- 모든 차원에서 합계 가능
- 예: 매출금액, 수량, 비용

반가산형 (Semi-Additive):
- 일부 차원에서만 합계 가능
- 예: 잔고, 재고량 (시간 차원 제외)

비가산형 (Non-Additive):
- 합계 불가능, 평균이나 비율 계산
- 예: 단가, 비율, 온도
```

### 3. 세분화 수준 (Granularity)
```
세분화 수준 결정:
- 가장 상세한 분석 단위
- 비즈니스 요구사항 반영
- 성능과 저장공간 고려

예시:
거래 레벨: 개별 거래별 팩트
일별 레벨: 일별 집계 팩트
월별 레벨: 월별 집계 팩트
```

## 🏗️ Fact 테이블의 구조

### 기본 구조
```sql
CREATE TABLE 매출팩트 (
    -- 차원 키들 (외래키)
    일자키 NUMBER NOT NULL,
    고객키 NUMBER NOT NULL,
    상품키 NUMBER NOT NULL,
    지역키 NUMBER NOT NULL,
    
    -- 측정값들 (팩트)
    매출금액 NUMBER(15,2),
    수량 NUMBER(10),
    할인금액 NUMBER(15,2),
    이익금액 NUMBER(15,2),
    
    -- 외래키 제약조건
    FOREIGN KEY (일자키) REFERENCES 일자차원(일자키),
    FOREIGN KEY (고객키) REFERENCES 고객차원(고객키),
    FOREIGN KEY (상품키) REFERENCES 상품차원(상품키),
    FOREIGN KEY (지역키) REFERENCES 지역차원(지역키)
);
```

### 구성 요소

#### 1. 차원 키 (Dimension Keys)
```
역할: 차원 테이블과의 연결고리

특징:
- 외래키 역할
- NOT NULL 제약조건
- 복합 기본키 구성 요소
- 인덱스 최적화 대상

예시:
일자키: 20240315 (YYYYMMDD 형태)
고객키: 12345 (고객차원의 대리키)
상품키: 67890 (상품차원의 대리키)
```

#### 2. 측정값 (Measures)
```
역할: 분석 대상이 되는 수치 데이터

특징:
- 숫자형 데이터 타입
- 집계 연산 가능
- NULL 값 허용 (경우에 따라)
- 비즈니스 의미 명확

예시:
매출금액: 실제 판매 금액
수량: 판매된 상품 개수
할인금액: 적용된 할인 금액
```

## 📊 Fact 테이블 유형

### 1. 트랜잭션 팩트 테이블
```
특징:
- 개별 비즈니스 이벤트 저장
- 가장 상세한 수준
- 시간 순서대로 누적
- 대용량 데이터

예시: 주문 팩트 테이블
CREATE TABLE 주문팩트 (
    주문일자키 NUMBER,
    고객키 NUMBER,
    상품키 NUMBER,
    주문수량 NUMBER,
    주문금액 NUMBER(15,2),
    주문시간 TIMESTAMP
);

데이터 예시:
20240315, 12345, 67890, 2, 30000, 2024-03-15 14:30:25
20240315, 12346, 67891, 1, 15000, 2024-03-15 15:45:10
```

### 2. 주기적 스냅샷 팩트 테이블
```
특징:
- 정기적인 시점의 상태 저장
- 일정한 간격으로 측정
- 반가산형 측정값 주로 포함
- 트렌드 분석에 적합

예시: 재고 팩트 테이블
CREATE TABLE 재고팩트 (
    일자키 NUMBER,
    상품키 NUMBER,
    창고키 NUMBER,
    기초재고 NUMBER,
    입고수량 NUMBER,
    출고수량 NUMBER,
    기말재고 NUMBER
);

데이터 예시:
20240315, 67890, 1001, 100, 50, 30, 120
20240316, 67890, 1001, 120, 20, 40, 100
```

### 3. 누적 스냅샷 팩트 테이블
```
특징:
- 프로세스의 전체 생명주기 추적
- 여러 시점의 정보 포함
- 프로세스 분석에 적합
- 상대적으로 적은 데이터량

예시: 주문처리 팩트 테이블
CREATE TABLE 주문처리팩트 (
    주문번호 VARCHAR(15),
    고객키 NUMBER,
    주문일자키 NUMBER,
    결제일자키 NUMBER,
    배송일자키 NUMBER,
    완료일자키 NUMBER,
    주문금액 NUMBER(15,2),
    처리일수 NUMBER
);

데이터 예시:
ORD001, 12345, 20240315, 20240315, 20240316, 20240318, 50000, 3
```

## 🎨 Fact 테이블 설계 원칙

### 1. 적절한 세분화 수준 결정
```
고려사항:
- 비즈니스 요구사항
- 분석 패턴
- 성능 요구사항
- 저장 공간

예시:
너무 상세: 초별 매출 데이터 → 과도한 데이터량
너무 요약: 연별 매출 데이터 → 분석 제약
적절함: 일별/거래별 매출 데이터 → 균형
```

### 2. 측정값 선택
```
포함할 측정값:
✅ 자주 분석되는 수치
✅ 비즈니스 KPI와 직결
✅ 집계 연산이 의미있는 값
✅ 계산 가능한 파생 지표

제외할 측정값:
❌ 거의 사용되지 않는 수치
❌ 집계가 무의미한 값
❌ 차원 정보에 해당하는 값
❌ 계산으로 쉽게 구할 수 있는 값
```

### 3. 성능 최적화
```sql
-- 파티셔닝 적용
CREATE TABLE 매출팩트 (
    일자키 NUMBER,
    고객키 NUMBER,
    상품키 NUMBER,
    매출금액 NUMBER(15,2)
)
PARTITION BY RANGE (일자키) (
    PARTITION p202401 VALUES LESS THAN (20240201),
    PARTITION p202402 VALUES LESS THAN (20240301),
    PARTITION p202403 VALUES LESS THAN (20240401)
);

-- 인덱스 최적화
CREATE INDEX IDX_매출팩트_일자 ON 매출팩트(일자키);
CREATE INDEX IDX_매출팩트_고객 ON 매출팩트(고객키);
CREATE INDEX IDX_매출팩트_복합 ON 매출팩트(일자키, 고객키);
```

## 💡 고급 Fact 테이블 기법

### 1. 팩트리스 팩트 테이블 (Factless Fact Table)
```
특징:
- 측정값이 없는 팩트 테이블
- 이벤트 발생 여부만 기록
- 존재 자체가 의미

예시: 수업참석 팩트 테이블
CREATE TABLE 수업참석팩트 (
    일자키 NUMBER,
    학생키 NUMBER,
    과목키 NUMBER,
    교실키 NUMBER
    -- 측정값 없음, 참석 사실만 기록
);

활용:
-- 참석률 계산
SELECT 
    과목명,
    COUNT(*) as 참석건수,
    COUNT(DISTINCT 학생키) as 참석학생수
FROM 수업참석팩트 f
JOIN 과목차원 s ON f.과목키 = s.과목키
GROUP BY 과목명;
```

### 2. 집계 팩트 테이블 (Aggregate Fact Table)
```
특징:
- 사전 계산된 요약 데이터
- 성능 향상 목적
- 상위 레벨 분석 지원

예시: 월별매출 팩트 테이블
CREATE TABLE 월별매출팩트 (
    년월키 NUMBER,        -- 202403
    고객등급키 NUMBER,
    상품카테고리키 NUMBER,
    총매출금액 NUMBER(15,2),
    총수량 NUMBER,
    거래건수 NUMBER,
    평균주문금액 NUMBER(15,2)
);

-- 기본 팩트에서 집계하여 생성
INSERT INTO 월별매출팩트
SELECT 
    TRUNC(일자키/100) as 년월키,
    고객등급키,
    상품카테고리키,
    SUM(매출금액) as 총매출금액,
    SUM(수량) as 총수량,
    COUNT(*) as 거래건수,
    AVG(매출금액) as 평균주문금액
FROM 매출팩트 f
JOIN 고객차원 c ON f.고객키 = c.고객키
JOIN 상품차원 p ON f.상품키 = p.상품키
GROUP BY TRUNC(일자키/100), 고객등급키, 상품카테고리키;
```

### 3. 브리지 테이블 활용
```
문제: 다대다 관계 처리

예시: 하나의 주문에 여러 프로모션 적용
CREATE TABLE 주문프로모션브리지 (
    주문키 NUMBER,
    프로모션키 NUMBER,
    할인금액 NUMBER(15,2),
    가중치 NUMBER(5,4)  -- 할인 기여도
);

CREATE TABLE 주문팩트 (
    주문키 NUMBER,
    일자키 NUMBER,
    고객키 NUMBER,
    총주문금액 NUMBER(15,2),
    총할인금액 NUMBER(15,2)
);

-- 프로모션별 효과 분석
SELECT 
    p.프로모션명,
    SUM(b.할인금액) as 총할인금액,
    COUNT(DISTINCT f.주문키) as 적용주문수
FROM 주문팩트 f
JOIN 주문프로모션브리지 b ON f.주문키 = b.주문키
JOIN 프로모션차원 p ON b.프로모션키 = p.프로모션키
GROUP BY p.프로모션명;
```

## 🔍 Fact 테이블 품질 관리

### 데이터 품질 검증
```sql
-- 1. 참조 무결성 검증
SELECT COUNT(*) as 오류건수
FROM 매출팩트 f
LEFT JOIN 고객차원 c ON f.고객키 = c.고객키
WHERE c.고객키 IS NULL;

-- 2. 측정값 유효성 검증
SELECT COUNT(*) as 음수매출건수
FROM 매출팩트
WHERE 매출금액 < 0;

-- 3. 중복 데이터 검증
SELECT 일자키, 고객키, 상품키, COUNT(*)
FROM 매출팩트
GROUP BY 일자키, 고객키, 상품키
HAVING COUNT(*) > 1;

-- 4. 데이터 완성도 검증
SELECT 
    일자키,
    COUNT(*) as 거래건수,
    SUM(CASE WHEN 매출금액 IS NULL THEN 1 ELSE 0 END) as 매출금액_NULL건수
FROM 매출팩트
GROUP BY 일자키
ORDER BY 일자키;
```

## 🎯 실무 적용 가이드

### Fact 테이블 설계 체크리스트
```
비즈니스 요구사항:
□ 분석 목적이 명확한가?
□ 세분화 수준이 적절한가?
□ 필요한 측정값이 모두 포함되었는가?
□ 비즈니스 규칙이 반영되었는가?

기술적 요구사항:
□ 성능을 고려한 설계인가?
□ 적절한 인덱스가 설계되었는가?
□ 파티셔닝이 필요한가?
□ 데이터 품질 검증 로직이 있는가?

운영 요구사항:
□ ETL 프로세스가 설계되었는가?
□ 데이터 보관 정책이 수립되었는가?
□ 모니터링 체계가 있는가?
□ 백업 및 복구 계획이 있는가?
```

### 성능 최적화 팁
```
1. 적절한 데이터 타입 선택
   - 정수: NUMBER(10) vs NUMBER(15)
   - 소수: NUMBER(15,2) vs NUMBER(10,4)
   - 날짜: DATE vs TIMESTAMP

2. 파티셔닝 전략
   - 범위 파티셔닝: 날짜별
   - 해시 파티셔닝: 고객별
   - 복합 파티셔닝: 날짜+지역별

3. 인덱스 전략
   - 단일 컬럼 인덱스: 자주 사용되는 차원키
   - 복합 인덱스: 자주 함께 사용되는 차원키 조합
   - 비트맵 인덱스: 카디널리티가 낮은 컬럼
```

## 🎯 체크리스트: Fact 테이블 설계

### 설계 품질
- [ ] 비즈니스 프로세스를 정확히 반영하는가?
- [ ] 적절한 세분화 수준을 선택했는가?
- [ ] 필요한 측정값이 모두 포함되었는가?
- [ ] 가산성을 고려하여 설계했는가?

### 성능 고려
- [ ] 적절한 파티셔닝을 적용했는가?
- [ ] 효율적인 인덱스를 설계했는가?
- [ ] 데이터 타입을 최적화했는가?
- [ ] 집계 테이블 필요성을 검토했는가?

### 품질 관리
- [ ] 데이터 품질 검증 로직이 있는가?
- [ ] 참조 무결성이 보장되는가?
- [ ] 중복 데이터 방지 방안이 있는가?
- [ ] 정기적인 품질 모니터링 계획이 있는가?

---

**다음**: [4-7. 차원 모델링 용어 탐방(3): Dimension, Dimension 테이블](./07-dimension-table.md)